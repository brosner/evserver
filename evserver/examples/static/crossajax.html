<html>
<head>
    <script type="text/javascript" src="./comet.js"></script>

    <script type="text/javascript" charset="utf-8">
    var newdomain = extract_xss_domain(document.domain);
    if(document.domain != newdomain)
        document.domain = newdomain;
    </script>
</head>
<body>
    <script type="text/javascript" charset="utf-8">
        callback = getURLParam('callback');
        var xhr = null;
        function x(){
            var user_callback = parent[callback];
            var post_data     = parent[callback + '_post_data'];
            var ajax_method   = parent[callback + '_method'];
            var ajax_uri      = parent[callback + '_ajax_uri'];
            var onreadystatechange = function (){
                if(!xhr)
                    return;
                if(xhr.readyState != 4)
                    return;
                if(user_callback){
                    /* avoid passing xhr object directly to parent iframe */
                    var x = {};
                    x.readyState    = xhr.readyState;
                    x.responseText  = xhr.responseText;
                    x.responseBody  = xhr.responseBody;
                    x.status        = xhr.status;
                    x.statusText    = xhr.statusText;
                    user_callback(x);
                }
            };
            xhr = comet_create_ajax(ajax_uri, ajax_method, post_data, onreadystatechange);

            function gc2(){
                if(xhr){
                    xhr.onreadystatechange=function () {};
                    xhr.abort();
                    delete(xhr);
                    xhr = null;
                }
            }
            comet_attach_unload_event(gc2);
            document.comet_garbage = gc2;
            window.comet_garbage   = gc2;
        }
        x();
    </script>
</body>
</html>